// SPDX-License-Identifier: LGPL-2.1-only
// Copyright (C) 2021 James Hogan <james@albanarts.com>

#ifndef OSGXR_OpenXRDisplay
#define OSGXR_OpenXRDisplay 1

#include <osg/Referenced>
#include <osg/ref_ptr>
#include <osgViewer/View>

#include <cinttypes>
#include <string>

namespace osgViewer {

class XRState;

/** a camera for each OpenXR view.*/
class OSGVIEWER_EXPORT OpenXRDisplay : public ViewConfig
{
    public:

        enum FormFactor
        {
            HEAD_MOUNTED_DISPLAY,
            HANDHELD_DISPLAY,
        };

        enum BlendMode
        {
            // Matches XrEnvironmentBlendMode
            OPAQUE = 1,
            ADDITIVE = 2,
            ALPHA_BLEND = 3,
        };

        OpenXRDisplay();
        OpenXRDisplay(const std::string &appName,
                      uint32_t appVersion,
                      enum FormFactor formFactor);

        OpenXRDisplay(const OpenXRDisplay& rhs,
                      const osg::CopyOp& copyop=osg::CopyOp::SHALLOW_COPY);
        virtual ~OpenXRDisplay();

        META_Object(osgViewer, OpenXRDisplay);

        virtual void configure(osgViewer::View& view) const;

        void setApp(const std::string &appName, uint32_t appVersion)
        {
            _appName = appName;
            _appVersion = appVersion;
        }

        void setAppName(const std::string &appName)
        {
            _appName = appName;
        }
        const std::string &getAppName() const
        {
            return _appName;
        }

        void setAppVersion(uint32_t appVersion)
        {
            _appVersion = appVersion;
        }
        uint32_t getAppVersion() const
        {
            return _appVersion;
        }

        void setValidationLayer(bool validationLayer)
        {
            _validationLayer = validationLayer;
        }
        bool getValidationLayer() const
        {
            return _validationLayer;
        }

        void setFormFactor(enum FormFactor formFactor)
        {
            _formFactor = formFactor;
        }
        enum FormFactor getFormFactor() const
        {
            return _formFactor;
        }

        void preferEnvBlendMode(enum BlendMode mode)
        {
            uint32_t mask = (1u << (unsigned int)mode);
            _preferredEnvBlendModeMask |= mask;
            _allowedEnvBlendModeMask |= mask;
        }
        void allowEnvBlendMode(enum BlendMode mode)
        {
            uint32_t mask = (1u << (unsigned int)mode);
            _allowedEnvBlendModeMask |= mask;
        }

        void setUnitsPerMeter(float unitsPerMeter)
        {
            _unitsPerMeter = unitsPerMeter;
        }
        float getUnitsPerMeter(void) const
        {
            return _unitsPerMeter;
        }

    protected:

        friend class XRState;

        // For XrInstance creation
        std::string _appName;
        uint32_t _appVersion;
        bool _validationLayer;

        // To get XrSystem
        enum FormFactor _formFactor;

        // For choosing environment blend mode
        uint32_t _preferredEnvBlendModeMask;
        uint32_t _allowedEnvBlendModeMask;

        // How big the world
        float _unitsPerMeter;

        // Internal OpenXR state object
        // FIXME this should probably belong elsewhere
        mutable osg::ref_ptr<XRState> _state;
};

}

#endif
